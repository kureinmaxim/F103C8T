# RTOS Views — мониторинг FreeRTOS в Cursor

Расширение **RTOS Views** (`mcu-debug.rtos-views`) показывает живое состояние FreeRTOS задач,
очередей и памяти прямо в IDE во время отладки — вместо чтения логов UART3.

---

## Установка

`Ctrl+Shift+X` → в строке поиска ввести `RTOS Views` → найти издателя **mcu-debug** → **Install**

Или через палитру:
```
Ctrl+Shift+P → Extensions: Install Extensions → mcu-debug.rtos-views
```

> Требует уже установленного **Cortex-Debug** (`marus25.cortex-debug`).

---

## Настройка launch.json

Открыть [.vscode/launch.json](.vscode/launch.json) и добавить `"rtos": "FreeRTOS"` в конфигурацию отладки:

```json
{
  "name": "Debug (OpenOCD)",
  "type": "cortex-debug",
  "request": "launch",
  "servertype": "openocd",
  "executable": "${workspaceFolder}/Debug/primGPT.elf",
  "configFiles": ["primGPT Debug.cfg"],
  "searchDir": ["${workspaceFolder}"],
  "device": "STM32F103C8",
  "interface": "swd",
  "runToEntryPoint": "main",
  "preLaunchTask": "Build",
  "rtos": "FreeRTOS"
}
```

**Изменение одно** — строка `"rtos": "FreeRTOS"` в блоке `Debug (OpenOCD)`.

---

## Как открыть панель RTOS Views

1. Запустить отладку **`F5`**
2. Дождаться остановки на `main()`
3. В боковой панели нажать иконку **RTOS Views** (значок чипа/процессора)
   - Или: `Ctrl+Shift+P` → `RTOS Views: Focus on RTOS View`

Панель появится в нижней части или сбоку — можно перетащить куда удобно.

Панель RTOS Views не появляется сама — её нужно открыть вручную. Вот как:

Способ 1 (через палитру команд):

Запустите отладку F5 и дождитесь остановки на main()
Ctrl+Shift+P → наберите RTOS → выберите "RTOS Views: Focus on RTOS View"
Способ 2 (через меню View):

Во время отладки: View → Open View... → наберите RTOS
Выберите нужную панель (Tasks, Queues, Heap)
Способ 3 (через боковую панель Debug):

Ctrl+Shift+D — откроется панель Run and Debug
Внизу панели найдите секции RTOS: Tasks, RTOS: Queues, RTOS: Heap — они могут быть свёрнуты (нужно прокрутить вниз)
Важно: панели RTOS Views видны только во время активной отладки (после F5), и данные обновляются только когда процессор остановлен (на breakpoint или после Pause). Если отладка не запущена — панели будут пустыми или скрытыми.

Если после F5 + остановки на main() панели всё ещё пустые — это может быть из-за того, что на main() FreeRTOS ещё не инициализирован. Поставьте breakpoint после osKernelStart() (например в StartDefaultTask на main.c:484), и там RTOS Views покажет все задачи.

---

## Что показывает панель

### Tasks (Задачи)

Все три задачи проекта отображаются с полной информацией:

| Колонка | Описание |
|---------|----------|
| **Name** | Имя задачи (`defaultTask`, `LedTask`, `Uart1Task`) |
| **State** | Состояние: `Running` / `Blocked` / `Ready` / `Suspended` |
| **Priority** | Приоритет (Normal=1, AboveNormal=2) |
| **Stack Used** | Использовано стека в байтах |
| **Stack Size** | Размер стека: defaultTask=1024B, LedTask=512B, **Uart1Task=2048B** |
| **Stack Free** | Свободно байт (важно следить!) |

**Пороги безопасности для этого проекта (20KB RAM):**

| Задача | Стек | Тревога если свободно менее |
|--------|------|-----------------------------|
| defaultTask | 1024B | < 256B |
| LedTask | 512B | < 128B |
| Uart1Task | 2048B | < 256B |

### Queues (Очереди)

Очередь UART1 команд (40 элементов, тип `uint8_t`):

| Колонка | Описание |
|---------|----------|
| **Name** | Имя очереди (если задано) |
| **Length** | Максимальный размер (40) |
| **Used** | Сколько элементов сейчас в очереди |
| **Available** | Сколько свободных мест |

Если `Used` постоянно близко к 40 — очередь переполняется, команды теряются.

### Heap (Куча FreeRTOS)

| Колонка | Описание |
|---------|----------|
| **Total** | Всего heap: 10240 байт (10KB) |
| **Free** | Свободно сейчас |
| **Min Free** | Минимум за всё время работы (watermark) |

**Норма для этого проекта:**
- `Free` > 2048B — хорошо
- `Free` < 1024B — осторожно
- `Free` < 512B — критично, риск краша

---

## Как работать с панелью во время отладки

### Сценарий 1 — Проверка стека при нагрузке

1. `F5` — запустить отладку
2. Поставить breakpoint в `Uart1Task` ([main.c:~строка с обработкой команды](Core/Src/main.c))
3. Отправить команду через UART1
4. Когда программа остановится — посмотреть в RTOS Views → Tasks → `Uart1Task` → **Stack Free**
5. Если мало — увеличить стек в [main.c](Core/Src/main.c) (`osThreadNew` параметр `stack_size`)

### Сценарий 2 — Мониторинг heap в реальном времени

1. `F5` — запустить отладку
2. Несколько раз нажать **Pause** (`Shift+F5` не работает для pause — используйте кнопку ⏸ в панели отладки)
3. Каждый раз смотреть **Heap → Min Free** — это минимум за всё время
4. Если `Min Free` падает ниже 512B — проблема с памятью

### Сценарий 3 — Зависание задачи

Если программа "зависла" (LED не мигает):
1. Нажать **Pause** в панели отладки
2. В RTOS Views → Tasks посмотреть состояние каждой задачи
3. Если `LedTask` в состоянии `Blocked` слишком долго — проблема в коде
4. Если `Uart1Task` в `Running` постоянно — она захватила CPU (не отдаёт управление)

---

## Сравнение: RTOS Views vs UART3 логи

| | UART3 логи (текущий способ) | RTOS Views |
|--|----------------------------|------------|
| Обновление | Каждые 5 секунд | При каждом pause/breakpoint |
| Нужен COM-порт | Да | Нет |
| Данные задач | Только watermark в словах | Полная информация в байтах |
| Очереди | Нет | Да |
| Удобство | Нужен терминал | Прямо в Cursor |
| Работает без отладчика | Да | Нет |

> Оба способа дополняют друг друга: UART3 логи удобны в полевых условиях,
> RTOS Views — при разработке за компьютером.

---

## Если панель RTOS Views пустая

**Причина 1:** Не добавлен `"rtos": "FreeRTOS"` в `launch.json`
→ Добавить строку, перезапустить отладку

**Причина 2:** Отладчик ещё не дошёл до `main()` (FreeRTOS не инициализирован)
→ Подождать остановки на `main()` или поставить breakpoint после `osKernelStart()`

**Причина 3:** Версия FreeRTOS не поддерживается
→ Проект использует FreeRTOS v10.0.1 — поддерживается

---

## Быстрый старт (TL;DR)

```
1. Установить расширение: mcu-debug.rtos-views
2. Добавить в launch.json → "Debug (OpenOCD)": "rtos": "FreeRTOS"
3. F5 → дождаться main()
4. Открыть панель RTOS Views сбоку
5. Нажимать Pause для обновления данных
```

---

*FreeRTOS v10.0.1 · STM32F103C8T6 · 20KB RAM · 10KB heap*
